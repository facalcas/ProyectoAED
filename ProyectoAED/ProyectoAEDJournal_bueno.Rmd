---
title: "Suicidios en España año 2014-2023"
author:
  - name: "Fabián Calvo"
  - name: "Mario Martínez"
  - name: "Axel Valton"

affiliation:
  - num: 1
    address: |
      Muenster University of Applied Sciences - 
      Institute for Infrastructure, Water, Resources, Environment
      Correnstr. 25, 48149 Muenster, Germany
    email: leutnant@fh-muenster.de
  - num: 2
    address: |
      Your department
      Street, City, Country
    email: mail@mail.com

authorcitation: |
  Leutnant, D.; Doe, J.

firstnote: |
  Current address: Updated affiliation

secondnote: |
  These authors contributed equally to this work.

correspondence: |
  leutnant@fh-muenster.de; Tel.: +XX-000-00-0000.

journal: notspecified
type: article
status: submit

simplesummary: |
  A Simple summary goes here.

abstract: |
  A single paragraph of about 200 words maximum. For research articles, 
  abstracts should give a pertinent overview of the work. We strongly encourage
  authors to use the following style of structured abstracts, but without 
  headings: 1) Background: Place the question addressed in a broad context and
  highlight the purpose of the study; 2) Methods: Describe briefly the main
  methods or treatments applied; 3) Results: Summarize the article's main 
  findings; and 4) Conclusion: Indicate the main conclusions or interpretations. 
  The abstract should be an objective representation of the article, it must not 
  contain results which are not presented and substantiated in the main text and 
  should not exaggerate the main conclusions.

keywords: |
  keyword 1; keyword 2; keyword 3 (list three to ten pertinent keywords specific 
  to the article, yet reasonably common within the subject discipline.).

acknowledgement: |
  All sources of funding of the study should be disclosed. Please clearly 
  indicate grants that you have received in support of your research work. 
  Clearly state if you received funds for covering the costs to publish in open 
  access.

authorcontributions: |
  For research articles with several authors, a short paragraph specifying their 
  individual contributions must be provided. The following statements should be 
  used ``X.X. and Y.Y. conceive and designed the experiments; X.X. performed the 
  experiments; X.X. and Y.Y. analyzed the data; W.W. contributed 
  reagents/materials/analysis tools; Y.Y. wrote the paper.'' Authorship must be
  limited to those who have contributed substantially to the work reported.

funding: |
  Please add: ``This research received no external funding'' or ``This research 
  was funded by NAME OF FUNDER grant number XXX.'' and  and ``The APC was funded 
  by XXX''. Check carefully that the details given are accurate and use the 
  standard spelling of funding agency names at 
  \url{https://search.crossref.org/funding}, any errors may affect your future 
  funding.

institutionalreview: |
  In this section, you should add the Institutional Review Board Statement and 
  approval number, if relevant to your study. You might choose to exclude 
  this statement if the study did not require ethical approval. Please note 
  that the Editorial Office might ask you for further information. Please add 
  “The study was conducted in accordance with the Declaration of Helsinki, 
  and approved by the Institutional Review Board (or Ethics Committee) of 
  NAME OF INSTITUTE (protocol code XXX and date of approval).” for studies 
  involving humans. OR “The animal study protocol was approved by the 
  Institutional Review Board (or Ethics Committee) of NAME OF INSTITUTE 
  (protocol code XXX and date of approval).” for studies involving animals. 
  OR “Ethical review and approval were waived for this study due to REASON 
  (please provide a detailed justification).” OR “Not applicable” for
   studies not involving humans or animals.

informedconsent: |
  Any research article describing a study involving humans should contain this 
  statement. Please add ``Informed consent was obtained from all subjects 
  involved in the study.'' OR ``Patient consent was waived due to REASON 
  (please provide a detailed justification).'' OR ``Not applicable'' for 
  studies not involving humans. You might also choose to exclude this statement 
  if the study did not involve humans.
  
  Written informed consent for publication must be obtained from participating 
  patients who can be identified (including by the patients themselves). Please 
  state ``Written informed consent has been obtained from the patient(s) to 
  publish this paper'' if applicable.

dataavailability: |
  We encourage all authors of articles published in MDPI journals to share 
  their research data. In this section, please provide details regarding where 
  data supporting reported results can be found, including links to publicly 
  archived datasets analyzed or generated during the study. Where no new data 
  were created, or where data is unavailable due to privacy or ethical 
  re-strictions, a statement is still required. Suggested Data Availability 
  Statements are available in section “MDPI Research Data Policies” at 
  \url{https://www.mdpi.com/ethics}.

conflictsofinterest: |
  Declare conflicts of interest or state 'The authors declare no conflict of 
  interest.' Authors must identify and declare any personal circumstances or
  interest that may be perceived as inappropriately influencing the
  representation or interpretation of reported research results. Any role of the
  funding sponsors in the design of the study; in the collection, analyses or 
  interpretation of data in the writing of the manuscript, or in the decision to 
  publish the results must be declared in this section. If there is no role, 
  please state 'The founding sponsors had no role in the design of the study; 
  in the collection, analyses, or interpretation of data; in the writing of the 
  manuscript, an in the decision to publish the results'.

supplementary: |
 The following supporting information can be downloaded at:  
 \linksupplementary{s1}, Figure S1: title; Table S1: title; Video S1: title.

abbreviations:
  - short: MDPI
    long: Multidisciplinary Digital Publishing Institute
  - short: DOAJ
    long: Directory of open access journals
  - short: TLA
    long: Three letter acronym
  - short: LD 
    long: linear dichroism

bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false

output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
---


# Version

This Rmd-skeleton uses the mdpi Latex template published 2024-03-21. 
However, the official template gets more frequently updated than the **rticles**
package. Therefore, please make sure prior to paper submission, that you're 
using the most recent .cls, .tex and .bst files 
(available [here](http://www.mdpi.com/authors/latex)).

# Article Header Information

The YAML header includes information needed mainly for formatting the front and 
back matter of the article. Required elements include:

```yaml
title: Title of the paper
author:
  - name: first and last name
    affil: |
      One or more comma seperated numbers corresponding to affilitation
      and one or more  comma seperated symbols corresponding 
      optional notes.
    orcid: optional orcid number
affiliation:  
  - num: 1,..., n for each affiliation
    address: required
    email: required
authorcitation: |
  Lastname, F.
correspondence: |
  email@email.com; Tel.: +XX-000-00-0000.
journal: notspecified
type: article
status: submit
```

Journal options are in Table \ref{tab:mdpinames}. The `status` variable should 
generally not be changed by authors. The `type` variable describes 
the type of of submission and defaults to `article` but can be replaced with any of the ones in Table \ref{tab:mdpitype}

```{r mdpitype, echo = FALSE}
type <- c("abstract, addendum, article, book, bookreview, briefreport, 
casereport, comment, commentary, communication, conferenceproceedings, 
correction, conferencereport, entry, expressionofconcern, extendedabstract, 
datadescriptor, editorial, essay, erratum, hypothesis, interestingimage, 
obituary, opinion, projectreport, reply, retraction, review, perspective, 
protocol, shortnote, studyprotocol, systematicreview, supfile, 
technicalnote, viewpoint, guidelines, registeredreport, tutorial")
knitr::kable(rticles::string_to_table(type, 3), 
             col.names = NULL, format = "latex", booktab = TRUE, 
             caption = "MDPI article types.")
```

## Journal Specific YAML variables

```yaml
# for journal Diversity,
# add the Life Science Identifier using:
lsid: http://zoobank.org/urn:lsid:zoobank.org:act:nnnn


# for journal Applied Sciences
# add featured application
featuredapplication: |
  Authors are encouraged to provide a concise 
  description of the specific application or 
  a potential application of the work. This 
  section is not mandatory.

# for the journal Data
# add dataset doi and license
dataset: https://doi.org/10.1000/182
datasetlicense: CC-BY-4.0

# for the journal Toxins
# add key contributions
keycontributions: |
  The breakthroughs or highlights of the manuscript. 
  Authors can write one or two sentences to describe 
  the most important part of the paper.

# for the journal Encyclopedia
encyclopediadef: |
  For entry manuscripts only: please provide a brief overview
  of the entry title instead of an abstract.
entrylink: The Link to this entry published on the encyclopedia platform.

# for the journal Advances in Respiratory Medicine
# add highlights
addhighlights: |
  This is an obligatory section in “Advances in Respiratory Medicine”, 
  whose goal is to increase the discoverability and readability of the
  article via search engines and other scholars. Highlights should not 
  be a copy of the abstract, but a simple text allowing the reader to 
  quickly and simplified find out what the article is about and what can 
  be cited from it. Each of these parts should be devoted up to 2~bullet 
  points.

```


\startlandscape
```{r, mdpinames, echo=FALSE, results='asis'}
mdpi_journals <- "acoustics, actuators, addictions, admsci, adolescents, aerobiology, aerospace, agriculture, agriengineering, agrochemicals, agronomy, ai, air, algorithms, allergies, alloys, analytica, analytics, anatomia, animals, antibiotics, antibodies, antioxidants, applbiosci, appliedchem, appliedmath, applmech, applmicrobiol, applnano, applsci, aquacj, architecture, arm, arthropoda, arts, asc, asi, astronomy, atmosphere, atoms, audiolres, automation, axioms, bacteria, batteries, bdcc, behavsci, beverages, biochem, bioengineering, biologics, biology, biomass, biomechanics, biomed, biomedicines, biomedinformatics, biomimetics, biomolecules, biophysica, biosensors, gases, gastroent, gastrointestdisord, gels, genealogy, genes, geographies, geohazards, geomatics, geosciences, geotechnics, geriatrics, grasses, gucdd, hazardousmatters, healthcare, hearts, hemato, hematolrep, heritage, higheredu, highthroughput, histories, horticulturae, hospitals, humanities, humans, hydrobiology, hydrogen, hydrology, hygiene, idr, ijerph, ijfs, ijgi, ijms, ijns, ijpb, ijtm, ijtpp, ime, immuno, informatics, information, infrastructures, inorganics, insects, instruments, inventions, iot, j, jal, jcdd, jcm, jcp, jcs, jcto, jdb, jeta, jfb, jfmk, jimaging, jintelligence, jlpea, jmmp, jmp, jmse, jne, jnt, jof, joitmc, jor, journalmedia, jox, jpm, jrfm, jsan, jtaer, jvd, jzbg, kidneydial, kinasesphosphatases, knowledge, land, languages, laws, life, liquids, literature, livers, logics, logistics, lubricants, lymphatics, machines, macromol, magnetism, magnetochemistry, make, marinedrugs, materials, materproc, mathematics, mca, measurements, medicina, medicines, medsci, membranes, merits, metabolites, metals, meteorology, methane, metrology, micro, microarrays, microbiolres, micromachines, microorganisms, microplastics, minerals, mining, modelling, molbank, molecules, mps, msf, mti, muscles, nanoenergyadv, nanomanufacturing, nanomaterials, ncrna, ndt, network, neuroglia, neurolint, neurosci, nitrogen, notspecified, nri, nursrep, nutraceuticals, nutrients, obesities, oceans, ohbm, onco, oncopathology, optics, oral, organics, organoids, osteology, oxygen, parasites, parasitologia, particles, pathogens, pathophysiology, pediatrrep, pharmaceuticals, pharmaceutics, pharmacoepidemiology, pharmacy, philosophies, photochem, photonics, phycology, physchem, physics, physiologia, plants, plasma, platforms, pollutants, polymers, polysaccharides, poultry, powders, preprints, proceedings, processes, prosthesis, proteomes, psf, psych, psychiatryint, psychoactives, publications, quantumrep, quaternary, qubs, radiation, reactions, receptors, recycling, regeneration, religions, remotesensing, reports, reprodmed, resources, rheumato, risks, robotics, ruminants, safety, sci, scipharm, sclerosis, seeds, sensors, separations, sexes, signals, sinusitis, skins, smartcities, sna, societies, socsci, software, soilsystems, solar, solids, spectroscj, sports, standards, stats, std, stresses, surfaces, surgeries, suschem, sustainability, symmetry, synbio, systems, targets, taxonomy, technologies, telecom, test, textiles, thalassrep, thermo, tomography, tourismhosp, toxics, toxins, transplantology, transportation, traumacare, traumas, tropicalmed, universe, urbansci, uro, vaccines, vehicles, venereology, vetsci, vibration, virtualworlds, viruses, vision, waste, water, wem, wevj, wind, women, world, youth, zoonoticdis"

knitr::kable(rticles::string_to_table(mdpi_journals, 8),
             col.names = NULL,
             format = "latex",
             booktabs = TRUE, 
             caption = "MDPI journal names.",
             longtable = TRUE)

```
\finishlandscape




# Introduction

El análisis de los suicidios constituye una tema de gran relevancia social y de salud pública, ya que permite comprender mejor los factores que influyen en este fenómeno y orientar estrategias de prevención más efectivas. En este estudio se reúne información detallada de suicidios en España clasificados según diferentes factores tales como la edad, el sexo, la nacionalidad y la comunidad autónoma.

A través de la exploración de dichas variables trataremos de encontrar patrones, tendencias o posibles grupos de riesgos. Este estudio tiene el objetivo no solo de describir los datos sino también de encontrar relaciones entre ellas y así servir de ayuda para tomar medidas de prevención.

# Materials and Methods

Para nuestro caso de estudio, hemos obtenido los datos de suicidios proporcionados por el Instituto Nacional de Estadística (INE).
En particular hemos importado los datos de suicidios de 2014 a 2023 divididos en 3 datasets.

Uno de ellos contiene un desglose por sexo, edad y mes de defunción; otro de ellos añade el desglose de la nacionalidad; y el último de ellos añade la comunidad autónoma.

Dichos datasets provenían de archivos tipo excels distintos (uno por año) que vienen en formato no tidy y que previamente a todo el tratamiento se transformarán a formato tidy y se concatenarán.

Posteriormente, se realizará una inspección de cada una de las variables para entender nuestros conjuntos de datos y se obtendrán descripciones gráficas del número de suicidios, relativizándolas cuando se considere a través de datasets de población obtenidos también en el INE.

Por último, veremos si existe alguna relación entre alguno de nuestros factores y el número total de suicidios.

## Librerías necesarias

```{r}
pacman::p_load(tidyverse,lubridate,dplyr,stringr,readr,purrr)
```


## Análisis de los datos

### Mes de defunción sexo y edad

Tras transformar nuestro dataset a formato `tidy` y haber concatenado los distintos años, vamos a analizar un poco cada una de las variables.

Nuestras variables en este conjunto de datos son las siguientes:



## Tidy dataset CA, Sexo y Edad

```{r}
# Cargar la ubicación del archivo

archivos<-list.files("../data")

# Filtramos por los que terminan en _CSE.csv usando una expresion regular
archivos<-grep("CSE\\.csv$", archivos, value = TRUE)

# Creamos un df vacío en el que almacenar nuestros datos tratados y limpios
CSE_tidy<-data.frame()

for (CSE in archivos){
  
  # Generamos la ruta del archivo

  ruta <- paste0("../data/",CSE)
  
  # Cargamos el dataframe
  
  encoding<-guess_encoding(ruta)[[1]][1]
  
  df <- read_delim(ruta, delim = ";", 
                   escape_double = FALSE, col_types = cols(Sexo = col_character()), 
                   locale = locale(encoding = encoding), 
                   trim_ws = TRUE)
  
  names(df)[2]<-"Territorio"
  
  # Nos centramos solo en el ámbito Nacional
  
  df<-df %>%
    filter(Nacional!="Extranjero")
  
  # Eliminamos la columna Nacional
  
  df<-df[-1]
  
  # Sustituímos los NAs por Nacional
  
  df <- df %>% replace_na(list(Territorio = "Nacional"))
  
  # Creamos la columna año:
  
  # Primero extraemos el año del nombre del archivo
  
  año<- sub("_.*", "", CSE) #busca el patron y lo borra, así me quedo con la fecha
  
  # Ahora lo pasamos a variable tipo fecha
  
  año<-año %>% paste0("-01-01") %>%as.Date
  
  df <- df %>%
    mutate(Año = año)
  
  # Modificamos los nombres de las comunidades para que sea mas friendly
  
  df <- df %>%
    mutate(
      Territorio = Territorio %>%
        # 1) Quitar espacios extremos
        str_squish() %>%
        # 2) Quitar prefijo numérico
        str_remove("^\\d+\\s+") %>%
        # 3) Quedarse con lo anterior a la primera coma
        str_remove(",.*$") %>%
        # 4) Casos excepcionales
        str_replace("Balears", "Baleares")
      
  )

  #Modificamos Sexo, Edad de la misma forma
  df <- df %>%
    mutate(
      Edad = Edad %>%
        str_replace("Todas.*", "Todas") %>%
        str_replace("años", "") %>%
        str_replace("De ", "") %>%
        str_replace("Menores de ", "<") %>%
        str_replace(" y más", "+") %>%
        str_replace(" a ", "-")
    
  )

  df <- df %>%
    mutate(
      Sexo = Sexo %>%
        str_replace("Ambos.*", "Ambos")
    
  )


  #Ahora cabiaremos a tipo factor las otras columnas Territorio, Sexo, Edad

  df <- df %>%
    mutate(across(where(is.character), as.factor))
  #Finalmente apilamos en un único dataframe los datos de cada año
  
  CSE_tidy <- CSE_tidy %>% rbind(df)
  
  # Reordenamos las columnas
CSE_tidy <- CSE_tidy %>% 
  select(Año,Territorio, Sexo, Edad, Total)

# Para graficar la pirámide de población
CSE_graf <- CSE_tidy %>%
  # Para que un sexo se dibuje “hacia la izquierda” y otro hacia la derecha, una de las poblaciones debe ser negativa:
  mutate(Total = ifelse(Sexo == "Hombres", -Total, Total)) %>%
  filter(Sexo != "Ambos") %>%
  filter(Edad != "Todas") %>%
  filter(Territorio == "Nacional") %>%
  select(Año,Sexo,Edad,Total)
# Para graficar el mapa
CSE_map <- CSE_tidy %>%
  filter(Sexo == "Ambos") %>%
  filter(Edad == "Todas") %>%
  filter(Territorio != "Nacional") %>%
  select(Año,Territorio,Total)
}
```


## Mes, Sexo y Edad
```{r Codificacion MSE}
guess_encoding("../data/2014_MSE.csv")
#Tienen codificación UTF-8
```

```{r MSE}

# Creamos dataframe base vacío
MSE <- data.frame(
  "Mes de defunción" = character(),
  Sexo = character(),
  Edad = character(),
  Total = numeric(),
  stringsAsFactors = FALSE
)

colnames(MSE)[1] <- "Mes de defunción"

# Función para ir concatenando los dataframes anuales
cargar_y_añadir_MSE <- function(MSE, archivo){
  MSE_año <- read_delim(paste0("../data/",archivo), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, locale = locale(grouping_mark = "."))
  MSE_año$Año <- gsub(pattern = "_[^1-9]*","", x = archivo)
  MSE <- rbind(MSE,MSE_año)
  return(MSE)
}

lista_archivos <- grep(x = list.files("../data"), pattern="[1-9]*_MSE.*", value= TRUE)
for (archivo in lista_archivos){
  MSE <- cargar_y_añadir_MSE(MSE, archivo)
}

# Convertimos los datos al tipo correcto
MSE[colnames(MSE)!="Total"] <- as.data.frame(lapply(MSE[colnames(MSE)!="Total"],as.factor))

# Reordenamos las columnas
MSE <- MSE %>% 
  select(Año,"Mes de defunción", Sexo, Edad, Total)
```

## Nacionalidad y Sexo

```{r}
readr::guess_encoding(file="../data/2023ns.csv", n= 1000)

# Se crea la función procesar_archivo_ns que hace tidy un solo archivo de ns

procesar_archivo_ns <- function(archivo_ns) {
  patron_ns <- "(\\d+)ns\\.csv"
  matches_ns <- str_match(archivo_ns, patron_ns)
  año_extraido_ns <- as.numeric(matches_ns[1, 2])

# La expresión regular para sacar el año es: (\\d+) [que significa encuentra un dígito y lo que está después de él] ns [toma también "ns" literal] \\. [toma también un . literal] csv [toma también los caracteres csv] [de esta forma identifica el patrón específico de los archivos guardados de nacionalidad-sexo ns]
# La función str_match empareja la ruta de los archivos ns con su respectivo patrón separado por año
# Con año_extraido_ns 
    
  datos_ns_limpios <- read_delim(
    archivo_ns,
    delim = ";",
    escape_double = FALSE,
    trim_ws = TRUE,
    locale = locale(encoding = "ISO-8859-1", decimal_mark = ","),
    col_types = cols(
      Edad = col_character(),
      Nacionalidad = col_character(),
      Sexo = col_character(),
      Total = col_number()
      ),
    show_col_types = FALSE
    ) %>%
    
# Con esta porción del código se importan los archivos ns de la carpeta data, con el encoding adecuado, y desde aquí se le asigna las columnas su tipo adecuado. show_col_types = F es para no llenar la consola de los tipos de las columnas  
    
    dplyr::filter(Edad == "Todas las edades") %>%
    dplyr::filter(Nacionalidad != "Total" & Sexo != "Ambos sexos") %>%
    select(Nacionalidad, Sexo, Total) %>%
    mutate(
      Año = factor(año_extraido_ns,levels = 2014:2023),
      Nacionalidad = factor(Nacionalidad, levels = c("Española", "Extranjera", "No consta")),
      Sexo = factor(Sexo, levels = c("Hombres", "Mujeres"))
      ) %>%
    select(Año, Nacionalidad, Sexo, Total)
  return(datos_ns_limpios)
}

# Con esta porción de código se filtran las edades para que no muestre toda la segmentación sino que muestre los valores Totales (se aprovecha que desde el propio dataset original ya viene el número total de suicidios sumado), con el segundo filter se "eliminan" errores que venían en estas columnas como "Total" en Nacionalidades y "Ambos sexos" para de esta forma mostrar las 3 tipos de nacionalidad que interesa y los dos sexos. Se seleccionan las columnas que nos interesan, con el mutate se crea la columna Año con el año_extraido_ns definido en pasos anteriores, y las columnas Nacionalidad y Sexo se hacen factor con los valores respectivos. Con el último select se ordenan las columnas para que sea más fácil de entender al mirar la tabla. 

lista_archivos_ns <- list.files(
  path = "../data/",
  pattern = "\\d+ns\\.csv$",
  full.names = TRUE
)

# Con esta porción de código se crea una lista con los documentos que hay en la carpeta data que cumplen con el patrón de ns (explicado anteriormente) y toma tods esos archivos.

datos_ns_tidy <- map_dfr(lista_archivos_ns, procesar_archivo_ns)

# Se hace uso de una función de purrr que es map_dfr y lo que hace es que a la lista de archivos que cumplen con el patrón de ns les aplica la función de hacerlos tidy, y lo que hace es crear dataframes individuales que concatena en un gran dataframe con todos los archivos en formato tidy en 1
```

Una vez importada los datos de suicidios en España distribuidos por la nacionalidad de las personas, se cuenta con un dateframe que cuenta con cuatro variables siendo estas:

```{r}
colnames(datos_ns_tidy)
```

La clase de estas variable son:
```{r}
str(datos_ns_tidy)
```

Se tiene que la variable Año es un factor con niveles de 2014 a 2023, la variable Nacionalidad de las personas se trata como un factor de tres niveles siendo estos: Española, Extranjera y No Consta. Siendo el nivel "No consta" como personas que se han suicidado pero no se pudo comprobar la nacionalidad de la persona. 

```{r}
suicidios_barras_nacionalidad<-datos_ns_tidy%>%
  group_by(Nacionalidad)%>%
  summarise(Total_Suicidios=sum(Total),.groups="drop")%>%
  mutate(Porcentaje=Total_Suicidios/sum(Total_Suicidios),
         Etiqueta_Porcentaje=scales::percent(Porcentaje,accuracy=0.01))

gr_barras_nacionalidad <- ggplot(suicidios_barras_nacionalidad,
                                 aes(x = reorder(Nacionalidad, -Total_Suicidios),
                                     y = Total_Suicidios,
                                     fill = Nacionalidad)) +
  geom_col() +
  geom_text(
    aes(label = Etiqueta_Porcentaje),
    vjust = 1.5,
    color = "white",
    size = 4
  ) +
  labs(
    title = "Proporción Total de Suicidios por Nacionalidad (2014-2023)",
    fill = "Nacionalidad",
    x = "Nacionalidad",
    y = "Número Total de Suicidios"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    legend.position = "none" 
  )

print(gr_barras_nacionalidad)

```

Como se puede observar en este gráfico, la proporción de datos de suicidios de personas de las que no se cuenta la nacionalidad es sumamente bajo. Por esta razón se prescindirán de estos registros para el análisis posterior de los datos segmentados por la nacionalidad de las personas.  

La variable Sexo cuenta con niveles Hombre y Mujer, y el número de suicidios se muestra en la variable Total y es de tipo numérica.
Se tiene un total de 60 datos, donde se muestran el total de suicidios registrados por año, y la información dividida por la nacionalidad de las personas. 

# Results

## Graficos Calendario

```{r grafico-defunciones a lo largo del tiempo}
library(ggplot2)
MSE_evolucion <-MSE %>% 
  filter(`Mes de defunción`=="Todos los meses", Sexo=="Ambos sexos", Edad=="Todas las edades")

MSE_evolucion %>% 
  ggplot(aes(x=Año, y=Total)) + geom_point() + geom_line(group=1)
```
```{r}
#Quitamos totales
MSE_sin_totales <- MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos",Edad!="Todas las edades")
```


```{r boxplot por meses MSE}
library(plotly)
p<-MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos", Edad!="Todas las edades") %>% 
  group_by(`Mes de defunción`,Año) %>% 
  summarise(Total_sum=sum(Total)) %>% 
  ggplot(aes(x=`Mes de defunción`, y=Total_sum))+ geom_boxplot()

p
#ggplotly(p)
```
```{r}
library(plotly)
for (año in unique(MSE$Año)) {
  
  df_year <- MSE_sin_totales %>% 
    filter(Año == año) %>%
    group_by(`Mes de defunción`, Sexo) %>% 
    summarise(Total_sum = sum(Total), .groups = "drop")
  
  p <- ggplot(df_year, aes(x = `Mes de defunción`, y=Total_sum)) +
        geom_bar(stat="identity", aes(fill=Sexo), position="dodge") +
        ggtitle(paste("Año:", año))
  
  #print(ggplotly(p))
}

```
```{r}
# library(plotly)
# library(dplyr)
# 
# anios <- unique(MSE_sin_totales$Año)
# sexos <- unique(MSE_sin_totales$Sexo)
# 
# fig <- plot_ly()
# 
# # --- Generar trazas por AÑO × SEXO ---
# for (a in seq_along(anios)) {
#   for (s in seq_along(sexos)) {
#     
#     df <- MSE_sin_totales %>% 
#       filter(Año == anios[a], Sexo == sexos[s])
#     
#     fig <- fig %>%
#       add_bars(
#         data = df,
#         x = ~`Mes de defunción`,
#         y = ~Total,
#         name = paste(anios[a], sexos[s]),
#         visible = ifelse(a == 1, TRUE, FALSE)
#       )
#   }
# }
# 
# # Cantidad de trazas por año
# trazas_por_anio <- length(sexos)
# 
# fig <- fig %>%
#   layout(
#     barmode = "group",
#     updatemenus = list(
#       list(
#         type = "dropdown",
#         buttons = lapply(seq_along(anios), function(a){
#           # vector de visibilidad, uno por traza
#           visibles <- rep(FALSE, length(anios) * trazas_por_anio)
#           
#           # activar las trazas del año a
#           inicio <- (a - 1) * trazas_por_anio + 1
#           fin <- inicio + trazas_por_anio - 1
#           visibles[inicio:fin] <- TRUE
#           
#           list(
#             method = "update",
#             label = anios[a],
#             args = list(list(visible = visibles))
#           )
#         })
#       )
#     )
#   )
# 
# fig

```

## Graficas Lineas, Nacionalidades

```{r}
library(ggplot2)
library(dplyr)
library(plotly)
library(scales)
library(ggrepel)

suicidios_por_nacionalidad<-datos_ns_tidy%>%
  group_by(Año,Nacionalidad)%>%
  summarise(Total_Suicidios=sum(Total))%>%
  filter(Nacionalidad!="No consta")

suicidios_barras_nacionalidad<-datos_ns_tidy%>%
  group_by(Nacionalidad)%>%
  summarise(Total_Suicidios=sum(Total),.groups="drop")%>%
  mutate(Porcentaje=Total_Suicidios/sum(Total_Suicidios),
         Etiqueta_Porcentaje=scales::percent(Porcentaje,accuracy=0.01))

suicidios_por_año<-datos_ns_tidy%>%
  group_by(Año)%>%
  summarise(Total_Suicidios=sum(Total))


gr_por_año<-ggplot(suicidios_por_año, aes(x=Año, y=Total_Suicidios, group=1)) +
  geom_line(color="blue") +
  geom_point(color="blue") +
  labs(title = "Evolución del Total de Suicidios en España (2014-2023)",
       y = "Número de Suicidios",
       x = "Año") +
  theme_minimal()

# En el código de este gráfico es importante el group=1 porque como los años están como factor, para que los tome cada uno como un valor del eje

print(gr_por_año)

gr_pastel_nacionalidad<-ggplot(suicidios_pastel_nacionalidad,aes(x="",y=Total_Suicidios,fill = Nacionalidad))+
  geom_col(width=1)+
  coord_polar(theta="y")+
  ggrepel::geom_label_repel(
    aes(label = Etiqueta_Porcentaje),
    position = position_stack(vjust = 0.5),
    show.legend = FALSE,
    segment.color = "grey50"
  ) +  
  labs(
    title = "Proporción Total de Suicidios por Nacionalidad (2014-2023)",
    fill = "Nacionalidad",
    x = NULL,
    y = NULL
  ) +
  theme_void() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )

print(gr_pastel_nacionalidad)

# gra_barras_nac<-plot_ly(
#   data=suicidios_por_nacionalidad,
#   x= ~Nacionalidad, y= ~Total_Suicidios,
#   color = ~Nacionalidad,
#   type="bar",
#   frame= ~Año,
#   customdata= ~Total_Suicidios,
#   hovertemplate=paste0(
#     "<b>%{x}</b><br>",
#     "Total: %{y}",
#     "<extra></extra>"
#     )
#   ) %>%
#   layout(
#     title=list(text="Suicidios en España por Nacionalidad"),
#     xaxis=list(title="Nacionalidad"),
#     yaxis=list(title="Número de Suicidios"),
#     showlegend=F
#   ) %>%
#   animation_slider(
#     currentvalue=list(prefix="Año: ")
#   ) %>%
#   animation_opts(
#     frame=600,
#     easing="linear",
#     redraw=F
#   )
# 
# print(gra_barras_nac)

gr_barras_nacionalidad <- ggplot(suicidios_barras_nacionalidad,
                                 aes(x = reorder(Nacionalidad, -Total_Suicidios),
                                     y = Total_Suicidios,
                                     fill = Nacionalidad)) +
  geom_col() +
  geom_text(
    aes(label = Etiqueta_Porcentaje),
    vjust = 1.5,
    color = "white",
    size = 4
  ) +
  labs(
    title = "Proporción Total de Suicidios por Nacionalidad (2014-2023)",
    fill = "Nacionalidad",
    x = "Nacionalidad",
    y = "Número Total de Suicidios"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    legend.position = "none" 
  )

print(gr_barras_nacionalidad)
```

```{r}
#Cargamos librerías para graficar
pacman::p_load(ggplot2,plotly,mapSpain,sf,scales)
```


##Grafica Piramide

```{r}
# library(ggplot2)
# 
# años<-levels(CSE_graf$Año)
# max_global <- max(abs(CSE_graf$Total))
# 
# for (año in años){
#   
#   data <- CSE_graf %>% 
#     filter(Año == año)
#   
# 
#   Grafico <-ggplot(data, aes(x = Edad, y = Total, fill = Sexo)) +
#     geom_col(width = 0.9) +
#     coord_flip() +
#     scale_y_continuous(labels = abs, limits = c(-max_global, max_global)) +
#     labs(
#       title = paste("Pirámide de suicidios",año),
#       x = "Edad",
#       y = "Suicidios",
#       fill = "Sexo"
#     ) +
#     theme_grey()
#   
#   print(Grafico)
#  
# }


```

```{r}
# brks <- pretty(c(0, max_global))
# tickvals <- c(-brks, brks)        # valores a ambos lados
# ticktext <- c(brks, brks)         # etiquetas siempre positivas
# 
# p <- plot_ly(
#   data = CSE_graf,
#   x = ~Total, y = ~Edad,
#   color = ~Sexo,
#   colors = c("Hombres" = "#E86E34", "Mujeres" = "#5E7CE2"),
#   type = "bar", orientation = "h",
#   frame = ~Año,
#   hovertemplate = "Edad: %{y}<br>Suicidios: %{customdata}<extra></extra>",
#   customdata = ~abs(Total)
# ) %>%
#   layout(
#     barmode = "relative",
#     # ----- Título centrado + más espacio arriba -----
#     title = list(text = "Pirámide de suicidios", x = 0.5, xanchor = "center",
#                  font = list(size = 22)),
#     margin = list(t = 90),                # más margen superior para el título
# 
#     # ----- Ejes -----
#     xaxis = list(
#       title = "Suicidios",
#       range = c(-(max_global+50), (max_global+50)),
#       tickvals = tickvals,
#       ticktext = ticktext,
#       zeroline = FALSE                    # quitamos la zeroline para usar la nuestra
#     ),
#     yaxis = list(title = "Edad"),
# 
#     # ----- Leyenda dentro de la trama -----
#     legend = list(
#       x = 0.98, y = 0.98,                 # esquina sup. derecha
#       xanchor = "right", yanchor = "top",
#       bgcolor = "rgba(255,255,255,0.75)", # caja semitransparente
#       bordercolor = "rgba(0,0,0,0.2)",
#       borderwidth = 1,
#       orientation = "v",
#       font = list(size = 12)
#     ),
# 
#     # ----- (Opcional) línea vertical en x=0 -----
#     shapes = list(list(
#       type = "line", x0 = 0, x1 = 0, xref = "x",
#       y0 = 0, y1 = 1, yref = "paper",
#       line = list(color = "rgba(0,0,0,0.6)", width = 1)
#     )),
# 
#     bargap = 0.15
#   ) %>%
#   animation_slider(currentvalue = list(prefix = "Año: ")) %>%
#   animation_opts(frame = 600, easing = "linear", redraw = FALSE)
# 
# p
```

## Grafica Mapa

```{r}
# #Cargamos las geometrías de las comunidades autonomas
# 
# ccaa<-esp_get_ccaa(moveCAN = T) %>% st_as_sf()
# 
# # Modificamos los nombres de las comunidades para que sea mas friendly
#   
# ccaa<-ccaa %>%
#   mutate(
#     Territorio = ine.ccaa.name %>%
#       # 1) Quitar espacios extremos
#       str_squish() %>%
#       # 2) Quitar prefijo numérico
#       str_remove("^\\d+\\s+") %>%
#       # 3) Quedarse con lo anterior a la primera coma
#       str_remove(",.*$") %>%
#       # 4) Casos excepcionales
#       str_replace("Balears", "Baleares")
#   ) %>%
#   # Filtramos columnas inecesarias
#   select(Territorio,geometry)
# 
# #Unimos la info
# 
# CSE_map<- ccaa %>%
#   left_join(CSE_map, by = "Territorio")
# 
# 
# ```
# 
# ```{r}
# for (año in años) {
#   
#   # Mapa base
#   g_mapa <- CSE_map %>%
#     filter(Año == año) %>%
#     ggplot() +
#     geom_sf(aes(fill = Total), color = "white", linewidth = 0.25) +
#   
#     # Escala en grises
#     scale_fill_stepsn(
#       colours = grey(seq(0.9, 0.1, length.out = 7)),
#       n.breaks = 7,
#       trans = "sqrt",
#       na.value = "grey95",
#       name = "Suicidios",
#       labels = label_comma()
#     ) +
#   
#     # solo el mapa (sin título ni leyenda “encima”)
#     theme_void() + #esto me quita las coordenadas
#     theme(
#       panel.background = element_rect(fill = "grey95", color = NA),
#       plot.background  = element_rect(fill = "grey95", color = "grey80", linewidth = 0.6),
#       legend.position = "none",   # quitamos la leyenda aquí (la añadimos fuera)
#       
#     ) +
#     # Añadimos titulo y leyenda fuera
#     labs(title = paste("Suicidios por CCAA —", año)) +
#     theme(
#       plot.title.position = "plot",
#       plot.background = element_rect(fill = "white", color = NA),
#       panel.background = element_rect(fill = "grey95", color = NA),
#       legend.position = "right"
#     )
#   
#   print(g_mapa)
    
#}
```
```{r}


# # Escala fija (opcional) para que todos los años compartan el mismo máximo
# zmax <- max(CSE_map$Total, na.rm = TRUE)
# 
# # Paleta en grises (claro -> oscuro)
# pal_grey <- grey(seq(0.95, 0.2, length.out = 7))
# 
# p_mapa <- plot_ly() %>%
#   add_sf(
#     data  = CSE_map,
#     split = ~Territorio,            # una traza por CCAA
#     frame = ~Año,                   # <-- slider por año
#     color = ~Total,                 # colorear por Total
#     colors = pal_grey,              # paleta en grises
#     text = ~paste0(
#       "<b>", Territorio, "</b><br>",
#       "Suicidios: ", comma(Total)
#     ),
#     hoverinfo = "text",
#     stroke = I("white"),            # borde blanco entre CCAA
#     span = I(1)                     # relleno sólido del polígono
#   ) %>%
#   layout(
#     title  = list(text = "Suicidios por CCAA", x = 0.5, xanchor = "center",
#                   font = list(size = 22)),
#     margin = list(t = 80, r = 110, b = 20, l = 20),
#     # Barra de color (leyenda) a la derecha, fuera del mapa
#     coloraxis = list(
#       colorscale = list(c(0, pal_grey[1]), c(1, pal_grey[length(pal_grey)])),
#       cmin = 0, cmax = zmax,
#       colorbar = list(title = "Suicidios", len = 0.8, x = 1.04, y = 0.5)
#     ),
#     showlegend = FALSE
#   ) %>%
#   animation_slider(currentvalue = list(prefix = "Año: ")) %>%
#   animation_opts(frame = 600, easing = "linear", redraw = FALSE)
# 
# p_mapa

```


## Subsection Heading Here

.

### Subsubsection Heading Here

Bulleted lists look like this:

* First bullet
* Second bullet
* Third bullet

Numbered lists can be added as follows:

1. First item
2. Second item
3. Third item

The text continues here.

## Figures, Tables and Schemes

All figures and tables should be cited in the main text as Figure \ref{fig:fig1}, 
\ref{tab:tab1}, etc. To get cross-reference to figure generated by R chunks 
include the `\\label{}` tag in the `fig.cap` attribute of the R chunk: 
`fig.cap = "Fancy Caption\\label{fig:plot}"`.

```{r fig1, echo=FALSE, fig.width=3, fig.cap="A figure added with a code chunk.\\label{fig:fig1}"}
x = rnorm(10)
y = rnorm(10)
plot(x, y)
```


When making tables using `kable`, it is suggested to use
the `format="latex"` and `tabl.envir="table"` arguments
to ensure table numbering and compatibility with the mdpi
document class.

```{r tab1, echo=FALSE}
knitr::kable(mtcars[1:5, 1:3], format = "latex", 
             booktabs = TRUE, 
             caption = "This is a table caption. Tables should be placed in the 
             main text near to the first time they are~cited.", 
             align = 'ccc', centering = FALSE,
             table.envir = "table", position = "H")
```



For a very wide table, landscape layouts are allowed.


\startlandscape

```{r tab2, echo=FALSE}
df <- data.frame(`Title 1` = c("Entry 1", "Entry 2"),
                 `Title 2` = c("Data", "Data"),
                 `Title 3` = c("Data", "Data"),
                 `Title 4` = c("This cell has some longer content that runs over
                               two lines",
                               "Data"))
knitr::kable(df, format = "latex", 
             booktabs = TRUE, 
             caption = "This is a very wide table", 
             align = 'ccc', centering = FALSE,
             table.envir = "table", position = "H")
```

\finishlandscape

## Formatting of Mathematical Components

This is an example of an equation:

$$
a = 1.
$$

If you want numbered equations use Latex and wrap in the equation environment:

\begin{equation}
a = 1,
\end{equation}

the text following an equation need not be a new paragraph. Please punctuate 
equations as regular text.

```{comment}
If the documentclass option "submit" is chosen, please insert a blank line before and after any math environment (equation and eqnarray environments). This ensures correct linenumbering. The blank line should be removed when the documentclass option is changed to "accept" because the text following an equation should not be a new paragraph.
```

This is the example 2 of equation:

\begin{adjustwidth}{-\extralength}{0cm}
\begin{equation}
a = b + c + d + e + f + g + h + i + j + k + l + m + n + o + p + q + r + s + t + 
u + v + w + x + y + z
\end{equation}
\end{adjustwidth}

Theorem-type environments (including propositions, lemmas, corollaries etc.) 
can be formatted as follows:

Example of a theorem:

::: {.Theorem latex=true}
Example text of a theorem
:::

The text continues here. Proofs must be formatted as follows:

Example of a proof:

::: {.proof latex="[Proof of Theorem1]"}
Text of the proof. Note that the phrase ``of Theorem 1'' is optional if it is 
clear which theorem is being referred to.
:::

The text continues here.

# Discussion

Authors should discuss the results and how they can be interpreted in 
perspective of previous studies and of the working hypotheses. The findings and 
their implications should be discussed in the broadest context possible. Future 
research directions may also be highlighted.

# Conclusion

This section is not mandatory, but can be added to the manuscript if the
discussion is unusually long or complex.

# Patents

This section is not mandatory, but may be added if there are patents resulting
from the work reported in this manuscript.
