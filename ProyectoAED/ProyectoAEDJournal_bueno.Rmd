---
title: "Análisis de los Suicidios Registrados en España en el Periodo 2014-2023"
author:
  - name: "Fabián Calvo Castillo"
    allfil: "1"
  - name: "Mario Martínez Guillen"
    allfil: "1"
  - name: "Axel Valton Juan"
    allfil: "1"
affiliation:
  - num: 1
    address: |
      Máster Universitario en Ciencia de Datos -
      Universitat de València -
      ETSE 
    email: "facalcas@alumni.uv.es"
authorcitation: |
  Calvo, F.; Martínez, M.; Valton, A.
correspondence: |
  marcelino.martinez@uv.es;
journal: notspecified
type: article
status: submit
simplesummary: |
  Proyecto Análisis Exploratorio de los Datos.
abstract: |
  Una vez finalizado el proyecto hacer el Abstract, resumen de lo que se hizo y se concluyó no superior a las 200 palabras.
keywords: |
  Suicidios; Mortalidad por Suicidio; España; Estadísticas de Mortalidad; Salud Pública; Análisis Exploratorio de Datos; Visualización de Datos 
  
acknowledgement: |
  
authorcontributions: |
  
funding: |
  This research received no external funding.
institutionalreview: |
  Not applicable.
informedconsent: |
  Not applicable.
dataavailability: |
  Los datos analizados en este estudio están disponibles públicamente y fueron 
  obtenidos del Instituto Nacional de Estadística (INE).
  https://ine.es/dyngs/INEbase/operacion.htm?c=Estadistica_C&cid=1254736176780&menu=resultados&idp=1254735573175#_tabs-1254736194710
conflictsofinterest: |
  The authors declare no conflict of interest.
supplementary: |
 
abbreviations:
  - short: MDPI
    long: Multidisciplinary Digital Publishing Institute
  - short: INE
    long: Instituto Nacional de Estadística
bibliography: mybibfile.bib
appendix: appendix.tex
endnotes: false
output: 
  rticles::mdpi_article:
    extra_dependencies: longtable
editor_options: 
  markdown: 
    wrap: 72
---

# Introducción

El suicidio representa un grave problema de salud pública en España, y
en todo el mundo, cuya comprensión es fundamental para el desarrollo de
estrategias de prevención efectivas. El análisis de datos sobre este
tema es el primer paso para hacer frente a la problemática con una base
empírica sólida para la toma de decisiones. Este estudio realiza un
análisis exploratorio de los datos registrados a la mortalidad por
suicidio en España durante el periodo de 2014 al 2023. El objetivo
principal es identificar y describir patrones, tendencias, disparidades
demográficas, geográficas y etarias en los datos registrados por el INE.
Se busca responder preguntas clave sobre la distribución de los
suicidios a lo largo del tiempo en territorio español. Para alcanzar
este objetivo, el análisis se estructura en torno a tres conjuntos de
datos diferenciados, el primero de ellos examina la distribución de
casos por año, comunidad autónoma, sexo y edad. El segundo conjunto
presenta datos repartidos por el mes en el que ocurrió el suceso.
Finalmente el tercer conjunto introduce la variable nacionalidad, sobre
los casos de mortalidad por suicidio registrados en España. A través de
la exploración y visualización de dichas variables, el trabajo pretende
describir la magnitud de la problemática que se enfrenta, y también
identificar relaciones entre las variables analizadas.

# Método

## Preparación y Adquisición de los Datos

El análisis se fundamenta en los datos de mortalidad por suicidio en
España para el periodo de 2014 a 2023, proporcionados por el INE. El
punto de partida consistió en múltiples archivos .csv (uno para cada año
de estudio), los cuales presentaban un formato estructurado, pero con
trabajo por hacer en cuanto al formato de columnas y su distinción por
año. Las librerías utilizadas para este análisis se presentan
acontinuación.

```{r}
pacman::p_load(tidyverse,lubridate,dplyr,stringr,readr,purrr,readxl,
               plotly,scales,ggrepel,mapSpain,sf)
```

El primer paso fue verificar la codificación de los conjuntos de datos,
con el resultado que los conjuntos de Nacionalidad y Sexo y el conjunto
de Comunidad Autónoma, Sexo y Edad comparten codificación, siendo esta
la `ISO-8859-1`. Mientras que el conjunto de datos de Mes, Sexo y Edad
presenta una codificación de `UTF-8`.

```{r Codificacion ns, include=FALSE}
guess_encoding("../data/2014ns.csv")
```

```{r Codificacion CSE, include=FALSE}
guess_encoding("../data/2014_CSE.csv")
```

```{r Codificación MSE, include=FALSE}
guess_encoding("../data/2014_MSE.csv")
```

Por esta razón, la importación de los conjuntos de datos se realiza en
la codificación respectiva, y el análisis y graficación de los datos
parte de la codificación asignada.

```{r MSE a Tidy, include=FALSE}
MSE <- data.frame(
  "Mes de defunción" = character(),
  Sexo = character(),
  Edad = character(),
  Total = numeric(),
  stringsAsFactors = FALSE
)

colnames(MSE)[1] <- "Mes de defunción"

cargar_y_añadir_MSE <- function(MSE, archivo){
  MSE_año <- read_delim(paste0("../data/",archivo), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, locale = locale(grouping_mark = ".",encoding="UTF-8"))
  MSE_año$Año <- gsub(pattern = "_[^1-9]*","", x = archivo)
  MSE <- rbind(MSE,MSE_año)
  return(MSE)
}

lista_archivos <- grep(x = list.files("../data"), pattern="[1-9]*_MSE.*", value= TRUE)
for (archivo in lista_archivos){
  MSE <- cargar_y_añadir_MSE(MSE, archivo)
}

MSE[colnames(MSE)!="Total"] <- as.data.frame(lapply(MSE[colnames(MSE)!="Total"],as.factor))

colnames(MSE)[colnames(MSE)=="Total"] <- "Total_suicidios"

MSE <- MSE %>% 
  select(Año,"Mes de defunción", Sexo, Edad, Total_suicidios)
```

```{r CSE a Tidy, include=FALSE}
archivos<-list.files("../data")

archivos<-grep("CSE\\.csv$", archivos, value = TRUE)

CSE_tidy<-data.frame()

for (CSE in archivos){
  ruta <- paste0("../data/",CSE)
  encoding<-guess_encoding(ruta)[[1]][1]
  
  df <- read_delim(ruta, delim = ";", 
                   escape_double = FALSE, col_types = cols(Sexo = col_character(),Total=col_number()), 
                   locale = locale(encoding = encoding,grouping_mark=".",decimal_mark = ","), 
                   trim_ws = TRUE)
  
  names(df)[2]<-"Territorio"
  
  df<-df %>%
    filter(Nacional!="Extranjero")
  
  df<-df[-1]
  
  df <- df %>% replace_na(list(Territorio = "Nacional"))
  
  año_texto<- sub("_.*", "", CSE)
  
  año<-factor(año_texto, levels = 2014:2023)
  
  df <- df %>%
    mutate(Año = año)
  
  df <- df %>%
    mutate(
      Territorio = Territorio %>%
        str_squish() %>%
        str_remove("^\\d+\\s+") %>%
        str_remove(",.*$") %>%
        str_replace("Balears", "Baleares")
  )

  df <- df %>%
    mutate(
      Edad = Edad %>%
        str_replace("Todas.*", "Todas") %>%
        str_replace("años", "") %>%
        str_replace("De ", "") %>%
        str_replace("Menores de ", "<") %>%
        str_replace(" y más", "+") %>%
        str_replace(" a ", "-")
  )

  df <- df %>%
    mutate(
      Sexo = Sexo %>%
        str_replace("Ambos.*", "Ambos")
  )
  

  df <- df %>%
    mutate(across(where(is.character), as.factor))

  CSE_tidy <- CSE_tidy %>% rbind(df)

CSE_tidy <- CSE_tidy %>% 
  select(Año,Territorio, Sexo, Edad, Total)

 }
```

```{r ns a Tidy, include=FALSE}
procesar_archivo_ns <- function(archivo_ns) {
  patron_ns <- "(\\d+)ns\\.csv"
  matches_ns <- str_match(archivo_ns, patron_ns)
  año_extraido_ns <- as.numeric(matches_ns[1, 2])

  datos_ns_limpios <- read_delim(
    archivo_ns,
    delim = ";",
    escape_double = FALSE,
    trim_ws = TRUE,
    locale = locale(encoding = "ISO-8859-1", decimal_mark = ","),
    col_types = cols(
      Edad = col_character(),
      Nacionalidad = col_character(),
      Sexo = col_character(),
      Total = col_number()
      ),
    show_col_types = FALSE
    ) %>%
    
    filter(Edad == "Todas las edades") %>%
    filter(Nacionalidad != "Total" & Sexo != "Ambos sexos") %>%
    select(Nacionalidad, Sexo, Total) %>%
    mutate(
      Año = factor(año_extraido_ns,levels = 2014:2023),
      Nacionalidad = factor(Nacionalidad, levels = c("Española", "Extranjera", "No consta")),
      Sexo = factor(Sexo, levels = c("Hombres", "Mujeres"))
      ) %>%
    select(Año, Nacionalidad, Sexo, Total)
  return(datos_ns_limpios)
}

lista_archivos_ns <- list.files(
  path = "../data/",
  pattern = "\\d+ns\\.csv$",
  full.names = TRUE
)

datos_ns_tidy <- map_dfr(lista_archivos_ns, procesar_archivo_ns)
```

Se destacan tareas de transformación y limpieza que se realizaron en los
conjuntos de datos seleccionados como la creación de una variable `Año`
para cada uno de los conjuntos, debido a que en los ficheros originales
descargados desde la página del INE no se contaba con esta variable. Se
implementó una función que mediante el uso de expresiones regulares
extraía el año (proveniente del nombre del fichero .csv), y se crea la
variable `Año` en base a esta extracción. También se destaca la gestión
de la respectiva codificación del conjunto de datos para evitar
problemas al importar los conjuntos además de la corrección en los tipos
de datos, referentes a la variables numéricas y categóricas que cada
dataset presenta. Una vez los ficheros se han tratado, se procede a su
concatenación para la creación de los tres respectivos conjuntos de
datos que serán utilizados para el análisis en el proyecto.

Por otro lado, para hacer un estudio de densidad, cargaremos los datos de la
polación española en el periodo entre 2014 y 2023.

Primero comprobamos la codificación de los archivos:

```{r}
guess_encoding("../data/Poblacion1.csv")
guess_encoding("../data/Poblacion2.csv")
```
Podemos ver que el dataset `Poblacion1.csv`  tiene codifcación `UTF-8`, y`Poblacion1.csv`, `ISO-8859-1`. 

Los cargamos en un dataframe.
```{r}

ruta <- "../data/Poblacion1.csv"
encoding<-guess_encoding(ruta)[[1]][1]
Poblacion1 <- read_delim(ruta, delim = ";", 
                   escape_double = FALSE, col_types = cols(Sexo = col_character(),Total=col_number()), 
                   locale = locale(encoding = encoding,grouping_mark=".",decimal_mark = ","), 
                   trim_ws = TRUE)

ruta <- "../data/Poblacion2.csv"
encoding<-guess_encoding(ruta)[[1]][1]
Poblacion2 <- read_delim(ruta, delim = ";", 
                   escape_double = FALSE, col_types = cols(Sexo = col_character(),Total=col_number()), 
                   locale = locale(encoding = encoding,grouping_mark=".",decimal_mark = ","), 
                   trim_ws = TRUE)

# Editamos los nombres de las variables y seleccionamos los datos con los que vamos a trabajar
  names(Poblacion1)[2]<-"Territorio"
  
  Poblacion1 <- Poblacion1 %>%
    filter(Sexo == "Ambos sexos", 
           `Edad (año a año)` == "TOTAL EDADES",
           Periodo >=2014 & Periodo <= 2023) %>%
    select(
           Año = Periodo,
           Territorio,
           Nacionalidad = `Españoles/Extranjeros`,
           Poblacion = Total,
           Sexo,
           Edad = `Edad (año a año)`
           )
    
# En la variable territorio faltan datos que corresponden a la totalidad del país  
  Poblacion1 <- Poblacion1 %>% replace_na(list(Territorio = "Nacional"))
  
# Modificamos las columnas characterpara que contengan nombres más fáciles a la hora de pasarlo a factor
  
    Poblacion1 <- Poblacion1 %>%
    mutate(
      Territorio = Territorio %>%
        str_squish() %>%
        str_remove("^\\d+\\s+") %>%
        str_remove(",.*$") %>%
        str_replace("Balears", "Baleares"),
      Sexo = "Ambos",
      Edad = "Todas"
  )
  
#Pasamos a factor
  Poblacion1 <- Poblacion1 %>%
    mutate(across(where(is.character), as.factor)) %>%
     mutate(across(Año, as.factor))
#Ahora preparamos Poblacion 2
  
  # Editamos los nombres de las variables y seleccionamos los datos con los que vamos a trabajar
  names(Poblacion2)[2]<-"Territorio"
  
  Poblacion2 <- Poblacion2 %>%
    select(
           Año = Periodo,
           Territorio,
           Poblacion = Total,
           Sexo
           ) %>%
    mutate(Edad = "Todas",
           Sexo= ifelse(Sexo=="Total","Ambos",Sexo))
    
# En la variable territorio faltan datos que corresponden a la totalidad del país  
  Poblacion2 <- Poblacion2 %>% replace_na(list(Territorio = "Nacional"))
  
# Modificamos las columnas characterpara que contengan nombres más fáciles a la hora de pasarlo a factor
  
    Poblacion2 <- Poblacion2 %>%
    mutate(
      Territorio = Territorio %>%
        str_squish() %>%
        str_remove("^\\d+\\s+") %>%
        str_remove(",.*$") %>%
        str_replace("Balears", "Baleares"),
  )
  
#Pasamos a factor
  Poblacion2 <- Poblacion2 %>%
    mutate(across(where(is.character), as.factor)) %>%
     mutate(across(Año, as.factor))

```

Y unimos estos datos en el dataframe `CSE_tidy` para poder trabajar en cifras por cada 100.000 habitantes

```{r}
CSE_tidy<-Poblacion1 %>% 
  select(-Nacionalidad) %>% 
  rbind(Poblacion2) %>%
  full_join(CSE_tidy, by = c("Año","Territorio","Edad","Sexo")) %>%
  # creamos col percapita y quitamos NA
  mutate(PerCap = ifelse(is.na(Poblacion),-99,Total/Poblacion*100000),
         Poblacion = ifelse(is.na(Poblacion),-99,Poblacion))
```

Como solo hemos trabajado con el total para las categoría de Edad, se han generado `NA` al unir los dataframes, hemos sustituído este dato por `-99`.

## Inspección de los Datos

### Mes de defunción sexo y edad

## Mes, Sexo y Edad

Con los datos consolidados, se realiza la explicación de las variables
con las que se cuenta para el análisis, y diversas características
presentes en cada uno de los datasets.

Tras transformar nuestro dataset a formato `tidy` y haber concatenado
los distintos años, vamos a analizar un poco cada una de las variables.

Nuestras variables en este conjunto de datos son las siguientes:

```{r, echo = FALSE}
str(MSE)
```

Vemos pues que disponemos de 5 variables llamadas `Año`,
`Mes de defunción`,`Sexo`,`Edad` y `Total_suicidios`. Los nombres de
estas vemos que son suficientemente representativos, y todas son de tipo
factor excepto la de `Total_suicidios` que es numérica. Nótese que la
variable año se ha codificado como factor en lugar de fecha porque
únicamente sirve como representación categórica para clasificar
anualmente los datos.

Vamos a inspeccionar un poco cada una de las variables.

En cuanto al `Año`, si miramos los distintos valores que puede tomar
vemos que efectivamente tenemos datos de los años desde 2014 hasta 2023.

```{r, echo=FALSE}
levels(MSE$Año)
```

Por otro lado, como cabría esperar la variable `Mes de defunción`
dispone de todos los meses del año, pero vemos una particularidad,
tenemos un agregado de "Todos los meses":

En cuanto al `Sexo` disponemos de "Hombres" y "Mujeres" y, además, de
nuevo tenemos un agregado de "Ambos sexos".

```{r, echo=FALSE}
levels(MSE$Sexo)
```

Para la última variable tipo factor (`Edad`) tenemos las siguientes
categorías:

```{r, echo=FALSE}
levels(MSE$Edad)
```

Como podemos observar, tenemos también un agregado de "Todas las
edades".

En vista de los datos tipo factor, realizamos una reordenación de los
meses y las edades, así como una eliminación de las filas
correspondientes a los registros "Ambos sexos","Todas las edades" y
"Todos los meses".

```{r, echo=FALSE}
MSE$`Mes de defunción` <- factor(MSE$`Mes de defunción`, levels=c("enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre", "Todos los meses"))

MSE$Edad <- factor(MSE$Edad, levels=c("Todas las edades","Menores de 15 años","De 15 a 29 años","De 30 a 39 años","De 40 a 44 años","De 45 a 49 años","De 50 a 54 años","De 55 a 59 años","De 60 a 64 años","De 65 a 69 años","De 70 a 74 años","De 75 a 79 años","De 80 a 84 años","De 85 a 89 años","De 90 a 94 años","De 95 años y más"))
MSE_sin_totales <- MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos", Edad!="Todas las edades")
```

Por último, la variable `Total_suicidios` hemos dicho que es una
variable numérica. Explorémosla un poco numéricamente. Para ello,
saquemos estadísticos por mes.

```{r, echo=FALSE}
summary(MSE_sin_totales$Total_suicidios)
```

Como vemos, hay meses, edades y sexos donde no se suicida nadie, y el
máximo son 45. Así mismo, de media entre todas las edades, sexos y meses
se suicidan 10.63 personas.

Además, este conjunto de datos no presentan datos faltantes:

```{r, echo = FALSE}
sum(is.na(MSE_sin_totales))
```

## Tidy dataset CA, Sexo y Edad

Una vez importado el conjunto de datos de los suicidios repartidos por
comunidad autónoma y su respectiva transformación a un conjunto en
formato tidy, el resultante es un dataframe con las siguientes
variables:

```{r, echo=FALSE}
colnames(CSE_tidy)
```

La clase de estas variables es la siguiente:

```{r, echo=FALSE}
str(CSE_tidy)
```

Siendo la variable `Año` un factor con los años de 2014 a 2023, la
variable `Territorio` un factor con las 19 Comunidades Autónomas de
España, incluyendo las ciudades autónomas, y un Total nacional, la
variable `Sexo` un factor con dos niveles siendo estos Hombres y
Mujeres; la variable `Edad` cuenta con 15 niveles siendo estos los
siguientes:

```{r, echo=FALSE}
levels(CSE_tidy$Edad)
```

Finalmente la variable `Total` muestra el número de suicidios
presentados en bajo las condiciones anteriormente explicadas. Se
verifica la presencia de valores ausentes en la variable `Total` con el
siguiente resultado:

```{r, echo=FALSE}
sum(is.na(CSE_tidy$Total))
```

## Nacionalidad y Sexo

Una vez importada los datos de suicidios en España distribuidos por la
nacionalidad de las personas, se cuenta con un dateframe que cuenta con
cuatro variables siendo estas:

```{r, echo=FALSE}
print(colnames(datos_ns_tidy))
```

La clase de estas variable son:

```{r, echo=FALSE}
print(str(datos_ns_tidy))
```

Se tiene que la variable `Año` es un factor con niveles de 2014 a 2023,
la variable `Nacionalidad` de las personas se trata como un factor de
tres niveles siendo estos: Española, Extranjera y No Consta. Siendo el
nivel "No consta" como personas que se han suicidado pero no se pudo
comprobar la nacionalidad de la persona.

```{r, echo=FALSE}
suicidios_barras_nacionalidad<-datos_ns_tidy%>%
  group_by(Nacionalidad)%>%
  summarise(Total_Suicidios=sum(Total),.groups="drop")%>%
  mutate(Porcentaje=Total_Suicidios/sum(Total_Suicidios),
         Etiqueta_Porcentaje=scales::percent(Porcentaje,accuracy=0.01))

gr_barras_nacionalidad <- ggplot(suicidios_barras_nacionalidad,
                                 aes(x = reorder(Nacionalidad, -Total_Suicidios),
                                     y = Total_Suicidios,
                                     fill = Nacionalidad)) +
  geom_col() +
  geom_text(
    aes(label = Etiqueta_Porcentaje),
    vjust = 1.5,
    color = "white",
    size = 4
  ) +
  labs(
    title = "Proporción Total de Suicidios por Nacionalidad (2014-2023)",
    fill = "Nacionalidad",
    x = "Nacionalidad",
    y = "Número Total de Suicidios"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    legend.position = "none" 
  )

print(gr_barras_nacionalidad)

```

Como se puede observar en este gráfico, la proporción de datos de
suicidios de personas de las que no se cuenta la nacionalidad es
sumamente bajo. Por esta razón se prescindirán de estos registros para
el análisis posterior de los datos segmentados por la nacionalidad de
las personas.

La variable `Sexo` cuenta con niveles Hombre y Mujer, y el número de
suicidios se muestra en la variable `Total` y es de tipo numérica. Se
tiene un total de 60 datos, donde se muestran el total de suicidios
registrados por año, y la información dividida por la nacionalidad de
las personas.

Para nuestro caso de estudio, hemos obtenido los datos de suicidios
proporcionados por el Instituto Nacional de Estadística (INE). En
particular hemos importado los datos de suicidios de 2014 a 2023
divididos en 3 datasets.

Uno de ellos contiene un desglose por sexo, edad y mes de defunción;
otro de ellos añade el desglose de la nacionalidad; y el último de ellos
añade la comunidad autónoma.

Dichos datasets provenían de archivos tipo excels distintos (uno por
año) que vienen en formato no tidy y que previamente a todo el
tratamiento se transformarán a formato tidy y se concatenarán.

Posteriormente, se realizará una inspección de cada una de las variables
para entender nuestros conjuntos de datos y se obtendrán descripciones
gráficas del número de suicidios, relativizándolas cuando se considere a
través de datasets de población obtenidos también en el INE.

Por último, veremos si existe alguna relación entre alguno de nuestros
factores y el número total de suicidios.


# Resultados

## Evolución anual del total de suicidios (2014–2023)

Una de las primeras preguntas que surgen a la hora de analizar nuestro
caso de estudio es qué evolución ha tenido el número de suicidios a lo
largo de los años. Para ello, podemos utilizar cualquiera de los 3
datasets que hemos comentado anteriormente, ya que todos ellos contienen
ímplicitamente la información de los suicidios totales en cada año.

```{r grafico-defunciones a lo largo del tiempo}
MSE_evolucion <-MSE %>% 
  filter(`Mes de defunción`=="Todos los meses", Sexo=="Ambos sexos", Edad=="Todas las edades")

MSE_evolucion %>% 
  ggplot(aes(x=Año, y=Total_suicidios)) + geom_point() + geom_line(group=1)+geom_vline(xintercept = "2020", linetype = "dashed", color = "red")
```
La serie temporal muestra oscilaciones moderadas en la segunda mitad de la década y un **aumento a partir de 2020** (línea vertical punteada en la figura), que se consolida en 2021–2022.


## Estacionalidad: distribución mensual (boxplots)

```{r}
#Quitamos totales
MSE_sin_totales <- MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos",Edad!="Todas las edades")
```

```{r boxplot por meses MSE}
p<-MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos", Edad!="Todas las edades") %>% 
  group_by(`Mes de defunción`,Año) %>% 
  summarise(Total_sum=sum(Total_suicidios)) %>% 
  ggplot(aes(x=`Mes de defunción`, y=Total_sum))+ geom_boxplot()

p
#ggplotly(p)
```
El diagrama de cajas por mes (agregando 2014–2023) sugiere un **patrón estacional**: los **meses de verano** (junio–agosto) presentan, en promedio, valores superiores a los meses de invierno, con picos entre **junio y julio**. Enero–febrero se sitúan en la parte baja de la distribución.



```{r}
for (año in unique(MSE$Año)) {
  
  df_year <- MSE_sin_totales %>% 
    filter(Año == año) %>%
    group_by(`Mes de defunción`, Sexo) %>% 
    summarise(Total_sum = sum(Total_suicidios), .groups = "drop")
  
  p <- ggplot(df_year, aes(x = `Mes de defunción`, y=Total_sum)) +
        geom_bar(stat="identity", aes(fill=Sexo), position="dodge") +
        ggtitle(paste("Año:", año))
  
  #print(ggplotly(p))
}

```

## Nacionalidad (acumulado 2014–2023)

```{r}

suicidios_por_nacionalidad<-datos_ns_tidy%>%
  group_by(Año,Nacionalidad)%>%
  summarise(Total_Suicidios=sum(Total))%>%
  filter(Nacionalidad!="No consta")

suicidios_barras_nacionalidad<-datos_ns_tidy%>%
  group_by(Nacionalidad)%>%
  summarise(Total_Suicidios=sum(Total),.groups="drop")%>%
  mutate(Porcentaje=Total_Suicidios/sum(Total_Suicidios),
         Etiqueta_Porcentaje=scales::percent(Porcentaje,accuracy=0.01))

suicidios_por_año<-datos_ns_tidy%>%
  group_by(Año)%>%
  summarise(Total_Suicidios=sum(Total))


gr_por_año<-ggplot(suicidios_por_año, aes(x=Año, y=Total_Suicidios, group=1)) +
  geom_line(color="blue") +
  geom_point(color="blue") +
  labs(title = "Evolución del Total de Suicidios en España (2014-2023)",
       y = "Número de Suicidios",
       x = "Año") +
  theme_minimal()

# En el código de este gráfico es importante el group=1 porque como los años están como factor, para que los tome cada uno como un valor del eje

print(gr_por_año)



# gra_barras_nac<-plot_ly(
#   data=suicidios_por_nacionalidad,
#   x= ~Nacionalidad, y= ~Total_Suicidios,
#   color = ~Nacionalidad,
#   type="bar",
#   frame= ~Año,
#   customdata= ~Total_Suicidios,
#   hovertemplate=paste0(
#     "<b>%{x}</b><br>",
#     "Total: %{y}",
#     "<extra></extra>"
#     )
#   ) %>%
#   layout(
#     title=list(text="Suicidios en España por Nacionalidad"),
#     xaxis=list(title="Nacionalidad"),
#     yaxis=list(title="Número de Suicidios"),
#     showlegend=F
#   ) %>%
#   animation_slider(
#     currentvalue=list(prefix="Año: ")
#   ) %>%
#   animation_opts(
#     frame=600,
#     easing="linear",
#     redraw=F
#   )
# 
# print(gra_barras_nac)

gr_barras_nacionalidad <- ggplot(suicidios_barras_nacionalidad,
                                 aes(x = reorder(Nacionalidad, -Total_Suicidios),
                                     y = Total_Suicidios,
                                     fill = Nacionalidad)) +
  geom_col() +
  geom_text(
    aes(label = Etiqueta_Porcentaje),
    vjust = 1.5,
    color = "white",
    size = 4
  ) +
  labs(
    title = "Proporción Total de Suicidios por Nacionalidad (2014-2023)",
    fill = "Nacionalidad",
    x = "Nacionalidad",
    y = "Número Total de Suicidios"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16),
    legend.position = "none" 
  )

print(gr_barras_nacionalidad)
```
El gráfico de barras muestra que la **gran mayoría de suicidios corresponde a personas de nacionalidad española** (≈90%), frente a un ~9–10% de extranjeras y una fracción mínima de “no consta”. Esta lectura es puramente **en términos absolutos**.

```{r}
# poblacion_NS <- read_excel("../data/poblacion_ASN.xlsx", skip=6, n_max = 9)
# View(poblacion_NS)
```

```{r, poblaciones_ns}
# df_tidy_poblacion_NS <- poblacion_NS %>%
#  rename(cat = 1) %>%
  
#  mutate(
#    Nacionalidad = if_else(cat %in% c("Española", "Extranjera"), cat, NA_character_),
#    edad         = if_else(cat == "Todas las edades", cat, NA_character_),
#    Sexo         = if_else(cat %in% c("Hombres", "Mujeres"), cat, NA_character_)
#  ) %>%
  
#  fill(Nacionalidad, edad, Sexo) %>%
  
#  filter(!(cat %in% c("Española", "Extranjera", "Todas las edades"))) %>%
  
#  pivot_longer(
#    cols = -c(cat, Nacionalidad, edad, Sexo),
#    names_to = "fecha",
#    values_to = "Poblacion"
#  ) %>%
  
#  mutate(
#    Año = as.factor(str_extract(fecha, "\\d{4}") |> as.integer())
#  ) %>%
#  select(Año,Nacionalidad,Sexo,  Poblacion)


#df_tidy_poblacion_NS <- datos_ns_tidy %>% filter(Nacionalidad!="No consta") %>% inner_join(df_tidy_poblacion_NS,by=c("Año","Nacionalidad","Sexo"))

#df_tidy_poblacion_NS <- df_tidy_poblacion_NS %>%
#  group_by(Año, Nacionalidad) %>%
#  summarise(
#    Suicidios_total = sum(Total, na.rm = TRUE),
#    Poblacion_total = sum(Poblacion, na.rm = TRUE),
#    .groups = "drop"
#  ) %>%
#  mutate(Tasa_suicidios = Suicidios_total / Poblacion_total)


#ggplot(df_tidy_poblacion_NS, aes(x = Año, y = Tasa_suicidios, color = Nacionalidad, group = Nacionalidad)) +
#  geom_line(size = 1.2) +
#  geom_point() +
#  labs(
#    title = "Tasa de suicidios por nacionalidad (total hombres + mujeres)",
#    x = "Año",
#    y = "Tasa de suicidios",
#    color = "Nacionalidad"
#  ) +
#  theme_minimal()

```

## Pirámides por sexo y edad

```{r}
# Para graficar la pirámide de población
CSE_graf <- CSE_tidy %>%
  # Para que un sexo se dibuje “hacia la izquierda” y otro hacia la derecha, una de las poblaciones debe ser negativa:
   mutate(Total = ifelse(Sexo == "Hombres", -Total, Total)) %>%
   filter(Sexo != "Ambos") %>%
   filter(Edad != "Todas") %>%
   filter(Territorio == "Nacional") %>%
   select(Año,Sexo,Edad,Total)
```


```{r}
  
  data <- CSE_graf #%>% 

   Grafico <-ggplot(data, aes(x = Edad, y = Total, fill = Sexo)) +
    geom_col(width = 0.9) +
    coord_flip() +
     scale_y_continuous(labels = abs,
                        limits = c(-max_global, max_global),
                        expand = c(0,0)) +
     labs(
       title = paste("Pirámide de suicidios"),
      x = "Edad",
       y = "Suicidios",
      fill = "Sexo"
    ) +
     facet_wrap(vars(Año), ncol = 5, nrow = 2) +
     theme_grey()
   print(Grafico)



```
Y haciendo la media por año
```{r}
data <- data %>%
  group_by(Edad,Sexo) %>%
  summarise(Total = mean(Total))

Grafico <-ggplot(data, aes(x = Edad, y = Total, fill = Sexo)) +
    geom_col(width = 0.9) +
    coord_flip() +
     scale_y_continuous(labels = abs,
                        limits = c(-max_global, max_global),
                        expand = c(0,0)) +
     labs(
       title = paste("Pirámide de suicidios promediada"),
      x = "Edad",
       y = "Suicidios",
      fill = "Sexo"
    )
 print(Grafico)

```
Las pirámides por año mantienen **formas muy similares** en todo el periodo. En la **pirámide promedio 2014–2023** se observa que la mayor carga se concentra en **grupos de edad de 30–59 años**, con un claro **exceso masculino** (aproximadamente el doble de casos que en mujeres en la mayoría de franjas). En edades muy avanzadas la contribución desciende de forma apreciable en ambos sexos.

## Distribución geográfica (CCAA)

```{r}
# Para graficar el mapa
 CSE_map <- CSE_tidy %>%
   filter(Sexo == "Ambos") %>%
   filter(Edad == "Todas") %>%
   filter(Territorio != "Nacional") %>%
   select(Año,Territorio,Total,PerCap) %>%
  #PROMEDIAMOS
   group_by(Territorio) %>%
   summarise(Total = mean(Total, na.rm = T),
             PerCap = mean(PerCap, na.rm = T))

 #Cargamos las geometrías de las comunidades autonomas
 
 ccaa<-esp_get_ccaa(moveCAN = T) %>% st_as_sf()

# Modificamos los nombres de las comunidades para que sea mas friendly
  
ccaa<-ccaa %>%
  mutate(
    Territorio = ine.ccaa.name %>%
      # 1) Quitar espacios extremos
      str_squish() %>%
      # 2) Quitar prefijo numérico
      str_remove("^\\d+\\s+") %>%
#       # 3) Quedarse con lo anterior a la primera coma
      str_remove(",.*$") %>%
#       # 4) Casos excepcionales
       str_replace("Balears", "Baleares")
   ) %>%
   # Filtramos columnas inecesarias
  select(Territorio,geometry)
 
 #Unimos la info
 
 CSE_map<- ccaa %>%
   left_join(CSE_map, by = "Territorio")
 

 
 
```

```{r}
#Por Totales
   
   # Mapa base
   g_mapa <- CSE_map %>%
     ggplot() +
     geom_sf(aes(fill = Total), color = "white", linewidth = 0.25) +
   
     # Escala en grises
     scale_fill_stepsn(
       colours = grey(seq(0.9, 0.1, length.out = 7)),
       n.breaks = 7,
       trans = "sqrt",
      na.value = "grey95",
      name = "Suicidios",
      labels = label_comma()
     ) +
   
     # solo el mapa (sin título ni leyenda “encima”)
     theme_void() + #esto me quita las coordenadas
     theme(
       panel.background = element_rect(fill = "grey95", color = NA),
       plot.background  = element_rect(fill = "grey95", color = "grey80", linewidth = 0.6),
       legend.position = "none",   # quitamos la leyenda aquí (la añadimos fuera)
      
    ) +
     # Añadimos titulo y leyenda fuera
     labs(title = "Suicidios Totales por CCAA") +
     theme(
       plot.title.position = "plot",
       plot.background = element_rect(fill = "white", color = NA),
       panel.background = element_rect(fill = "grey95", color = NA),
       legend.position = "right"
     )
   
   print(g_mapa)

#Por 100.000 Habt
   g_mapa <- CSE_map %>%
     ggplot() +
     geom_sf(aes(fill = PerCap), color = "white", linewidth = 0.25) +
   
     # Escala en grises
     scale_fill_stepsn(
       colours = grey(seq(0.9, 0.1, length.out = 7)),
       n.breaks = 7,
       trans = "sqrt",
      na.value = "grey95",
      name = "Suicidios",
      labels = label_comma()
     ) +
   
     # solo el mapa (sin título ni leyenda “encima”)
     theme_void() + #esto me quita las coordenadas
     theme(
       panel.background = element_rect(fill = "grey95", color = NA),
       plot.background  = element_rect(fill = "grey95", color = "grey80", linewidth = 0.6),
       legend.position = "none",   # quitamos la leyenda aquí (la añadimos fuera)
      
    ) +
     # Añadimos titulo y leyenda fuera
     labs(title = "Suicidios cada 100.000 Habitantes por CCAA") +
     theme(
       plot.title.position = "plot",
       plot.background = element_rect(fill = "white", color = NA),
       panel.background = element_rect(fill = "grey95", color = NA),
       legend.position = "right"
     )
   
   print(g_mapa)

```
- **Mapa de totales (conteos)**: las CCAA más pobladas concentran más casos, como era esperable por efecto de tamaño (p. ej., Andalucía). Por ello, este mapa sirve solo como referencia visual de volumen.
- **Mapa por 100.000 habitantes (promedio 2014–2023)**: al relativizar, emergen diferencias territoriales. Se aprecia un **gradiente con valores relativamente más altos hacia el norte y el este**, mientras que **Madrid y Cataluña** destacan por **valores medios-bajos** en la comparación per cápita dentro del periodo. Las **islas** (Baleares y Canarias) y el **sureste peninsular** (Andalucía oriental, Murcia, Comunidad Valenciana, Castilla–La Mancha) presentan un patrón intermedio. En el **noroeste** se observa un repunte relativo (promedio del periodo).

> Nota: estas son comparaciones **promedio 2014–2023**; en un análisis por año podrían aparecer matices. Además, las diferencias territoriales pueden reflejar tanto estructura demográfica como otros factores no observados (socioeconómicos, sanitarios, culturales, climáticos, etc.).


# Discusión

## Lecturas principales

1. **Tendencia reciente**: el incremento a partir de 2020 sugiere un cambio de nivel que conviene monitorizar. Sin analizar causas, podría estar relacionado con factores psicosociales y económicos relacionados con ese periodo, como podría ser la pandemia y la cuarentena.

2. **Estacionalidad**: el patrón verano > invierno es consistente en el agregado 2014–2023. Esto podría conectar con variables ambientales o sociales estacionales.

3. **Desigualdad por sexo y edad**: el exceso masculino y la concentración en 30–59 años son robustos a través del tiempo, lo que señala segmentos de **alto riesgo relativo** para focalizar políticas preventivas.

4. **Heterogeneidad territorial**: las diferencias entre CCAA **se acentúan** al trabajar con tasas. El patrón norte/este más alto (con la salvedad de Madrid y Cataluña) invita a explorar factores contextuales (estructura por edad, ocupación, renta, servicios de salud mental, ruralidad, etc.).


# Conclusion

This section is not mandatory, but can be added to the manuscript if the
discussion is unusually long or complex.

# Patents

This section is not mandatory, but may be added if there are patents
resulting from the work reported in this manuscript.
