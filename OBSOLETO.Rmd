---
title: "ProyectoAED"
author: "Fabián Calvo Castillo"
date: "2025-10-21"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list = ls())
```

Proyecto AED 9 de Noviembre Grupo E

```{r Codificacion MSE}
library(readr)
guess_encoding("data/2014_MSE.csv")
#Tienen codificación UTF-8
```

```{r MSE}
library(tidyverse)

# Creamos dataframe base vacío
MSE <- data.frame(
  "Mes de defunción" = character(),
  Sexo = character(),
  Edad = character(),
  Total = numeric(),
  stringsAsFactors = FALSE
)

colnames(MSE)[1] <- "Mes de defunción"

# Función para ir concatenando los dataframes anuales
cargar_y_añadir_MSE <- function(MSE, archivo){
  MSE_año <- read_delim(paste0("data/",archivo), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, locale = locale(grouping_mark = "."))
  MSE_año$Año <- gsub(pattern = "_[^1-9]*","", x = archivo)
  MSE <- rbind(MSE,MSE_año)
  return(MSE)
}

lista_archivos <- grep(x = list.files("data"), pattern="[1-9]*_MSE.*", value= TRUE)
for (archivo in lista_archivos){
  MSE <- cargar_y_añadir_MSE(MSE, archivo)
}

# Convertimos los datos al tipo correcto
MSE[colnames(MSE)!="Total"] <- as.data.frame(lapply(MSE[colnames(MSE)!="Total"],as.factor))
# Reordenamos las columnas
MSE <- MSE %>% 
  select(Año,"Mes de defunción", Sexo, Edad, Total)
```

##graficas

```{r grafico-defunciones a lo largo del tiempo}
library(ggplot2)
MSE_evolucion <-MSE %>% 
  filter(`Mes de defunción`=="Todos los meses", Sexo=="Ambos sexos", Edad=="Todas las edades")

MSE_evolucion %>% 
  ggplot(aes(x=Año, y=Total)) + geom_point() + geom_line(group=1)
```
```{r}
#Quitamos totales
MSE_sin_totales <- MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos",Edad!="Todas las edades")
```


```{r boxplot por meses MSE}
p<-MSE %>% 
  filter(`Mes de defunción`!="Todos los meses", Sexo!="Ambos sexos", Edad!="Todas las edades") %>% 
  group_by(`Mes de defunción`,Año) %>% 
  summarise(Total_sum=sum(Total)) %>% 
  ggplot(aes(x=`Mes de defunción`, y=Total_sum))+ geom_boxplot()

p
ggplotly(p)
```
```{r}
library(plotly)
for (año in unique(MSE$Año)) {
  
  df_year <- MSE_sin_totales %>% 
    filter(Año == año) %>%
    group_by(`Mes de defunción`, Sexo) %>% 
    summarise(Total_sum = sum(Total), .groups = "drop")
  
  p <- ggplot(df_year, aes(x = `Mes de defunción`, y=Total_sum)) +
        geom_bar(stat="identity", aes(fill=Sexo), position="dodge") +
        ggtitle(paste("Año:", año))
  
  print(ggplotly(p))
}

```
```{r}
library(plotly)
library(dplyr)

anios <- unique(MSE_sin_totales$Año)
sexos <- unique(MSE_sin_totales$Sexo)

fig <- plot_ly()

# --- Generar trazas por AÑO × SEXO ---
for (a in seq_along(anios)) {
  for (s in seq_along(sexos)) {
    
    df <- MSE_sin_totales %>% 
      filter(Año == anios[a], Sexo == sexos[s])
    
    fig <- fig %>%
      add_bars(
        data = df,
        x = ~`Mes de defunción`,
        y = ~Total,
        name = paste(anios[a], sexos[s]),
        visible = ifelse(a == 1, TRUE, FALSE)
      )
  }
}

# Cantidad de trazas por año
trazas_por_anio <- length(sexos)

fig <- fig %>%
  layout(
    barmode = "group",
    updatemenus = list(
      list(
        type = "dropdown",
        buttons = lapply(seq_along(anios), function(a){
          # vector de visibilidad, uno por traza
          visibles <- rep(FALSE, length(anios) * trazas_por_anio)
          
          # activar las trazas del año a
          inicio <- (a - 1) * trazas_por_anio + 1
          fin <- inicio + trazas_por_anio - 1
          visibles[inicio:fin] <- TRUE
          
          list(
            method = "update",
            label = anios[a],
            args = list(list(visible = visibles))
          )
        })
      )
    )
  )

fig

```





```{r}
library(readr)
library(dplyr)
library(stringr)
library(purrr)

readr::guess_encoding(file="data/2023ns.csv", n= 1000)

# Se crea la función procesar_archivo_ns que hace tidy un solo archivo de ns

procesar_archivo_ns <- function(archivo_ns) {
  patron_ns <- "(\\d+)ns\\.csv"
  matches_ns <- str_match(archivo_ns, patron_ns)
  año_extraido_ns <- as.numeric(matches_ns[1, 2])

# La expresión regular para sacar el año es: (\\d+) [que significa encuentra un dígito y lo que está después de él] ns [toma también "ns" literal] \\. [toma también un . literal] csv [toma también los caracteres csv] [de esta forma identifica el patrón específico de los archivos guardados de nacionalidad-sexo ns]
# La función str_match empareja la ruta de los archivos ns con su respectivo patrón separado por año
# Con año_extraido_ns 
    
  datos_ns_limpios <- read_delim(
    archivo_ns,
    delim = ";",
    escape_double = FALSE,
    trim_ws = TRUE,
    locale = locale(encoding = "ISO-8859-1", decimal_mark = ","),
    col_types = cols(
      Edad = col_character(),
      Nacionalidad = col_character(),
      Sexo = col_character(),
      Total = col_number()
      ),
    show_col_types = FALSE
    ) %>%
    
# Con esta porción del código se importan los archivos ns de la carpeta data, con el encoding adecuado, y desde aquí se le asigna las columnas su tipo adecuado. show_col_types = F es para no llenar la consola de los tipos de las columnas  
    
    dplyr::filter(Edad == "Todas las edades") %>%
    dplyr::filter(Nacionalidad != "Total" & Sexo != "Ambos sexos") %>%
    select(Nacionalidad, Sexo, Total) %>%
    mutate(
      Año = año_extraido_ns,
      Nacionalidad = factor(Nacionalidad, levels = c("Española", "Extranjera", "No consta")),
      Sexo = factor(Sexo, levels = c("Hombres", "Mujeres"))
      ) %>%
    select(Año, Nacionalidad, Sexo, Total)
  return(datos_ns_limpios)
}

# Con esta porción de código se filtran las edades para que no muestre toda la segmentación sino que muestre los valores Totales (se aprovecha que desde el propio dataset original ya viene el número total de suicidios sumado), con el segundo filter se "eliminan" errores que venían en estas columnas como "Total" en Nacionalidades y "Ambos sexos" para de esta forma mostrar las 3 tipos de nacionalidad que interesa y los dos sexos. Se seleccionan las columnas que nos interesan, con el mutate se crea la columna Año con el año_extraido_ns definido en pasos anteriores, y las columnas Nacionalidad y Sexo se hacen factor con los valores respectivos. Con el último select se ordenan las columnas para que sea más fácil de entender al mirar la tabla. 

lista_archivos_ns <- list.files(
  path = "data/",
  pattern = "\\d+ns\\.csv$",
  full.names = TRUE
)

# Con esta porción de código se crea una lista con los documentos que hay en la carpeta data que cumplen con el patrón de ns (explicado anteriormente) y toma tods esos archivos.

datos_ns_tidy <- map_dfr(lista_archivos_ns, procesar_archivo_ns)

# Se hace uso de una función de purrr que es map_dfr y lo que hace es que a la lista de archivos que cumplen con el patrón de ns les aplica la función de hacerlos tidy, y lo que hace es crear dataframes individuales que concatena en un gran dataframe con todos los archivos en formato tidy en 1

```


